using HDTelefoonKosten.Types;
using Serilog;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace HDTelefoonKosten.LogicManager
{
    internal partial class LogicManager
    {
        public static List<CallData> ParseAllRows(List<string> tempAllRowsList)
        {
            List<CallData> tempParsedRowsList = new List<CallData>();
            try
            {
                foreach (var Row in tempAllRowsList)
                {
                    DateTime dateTime;
                    var tempRow = Row;
                    if (tempRow.Contains("direction") || tempRow.Contains("dir") || tempRow.Contains("subscriber"))
                        continue;
                    if (!Row.StartsWith("out") && !Row.StartsWith("in") && !Row.StartsWith("Out") && !Row.StartsWith("In") && !Row.Contains(",,"))
                    {
                        tempParsedRowsList = ParseAllRowsException(tempAllRowsList);
                        return tempParsedRowsList;
                    }
                    if (tempRow.Contains(",,"))
                        tempRow = tempRow.Replace(",,", ",null,");
                    var tempSplitRow = Regex.Matches(tempRow, @"(?<="")[^""]+?(?=""(?:\s*?,|\s*?$))|(?<=(?:^|,)\s*?)(?:[^,""\s][^,""]*[^,""\s])|(?:[^,""\s])(?![^""]*?""(?:\s*?,|\s*?$))(?=\s*?(?:,|$))").Cast<Match>().Select(m => m.Value).ToArray();
                    if (tempSplitRow.Length == 0 || tempSplitRow.Length < 7)
                        continue;

                    CallData callData = new CallData();
                    MonthlyCostData monthlyCostData = new MonthlyCostData();
                    if (!string.IsNullOrEmpty(tempSplitRow[0]))
                        callData.Direction = tempSplitRow[0];
                    if (!string.IsNullOrEmpty(tempSplitRow[1]))
                        callData.Bedrijf = tempSplitRow[1];
                    if (!string.IsNullOrEmpty(tempSplitRow[2]))
                    {
                        callData.Subscriber = tempSplitRow[2];
                        monthlyCostData.Subscriber = tempSplitRow[2];
                    }
                    if (!string.IsNullOrEmpty(tempSplitRow[3]))
                        callData.Originator = tempSplitRow[3];
                    if (!string.IsNullOrEmpty(tempSplitRow[4]))
                        callData.Termination = tempSplitRow[4];
                    if (!string.IsNullOrEmpty(tempSplitRow[5]))
                        if (DateTime.TryParse(tempSplitRow[5], out dateTime))
                            callData.Date = dateTime;
                    if (!string.IsNullOrEmpty(tempSplitRow[6]))
                    {
                        if (!tempSplitRow[6].Contains("-"))
                            callData.Duration = double.Parse(tempSplitRow[6], CultureInfo.InvariantCulture);
                        else callData.Duration = 0;
                    }
                    if (!string.IsNullOrEmpty(tempSplitRow[7]))
                    {
                        if (!tempSplitRow[7].Contains("-"))
                            callData.Cost = double.Parse(tempSplitRow[7], CultureInfo.InvariantCulture);
                        else callData.Cost = 0;
                        tempParsedRowsList.Add(callData);
                    }
                }
            }
            catch (Exception ex)
            {
                Log.Error(ex.Message);
            }
            return tempParsedRowsList;
        }

        public static List<CallData> ParseAllRowsException(List<string> tempAllRowsList)
        {
            List<CallData> tempParsedRowsList = new List<CallData>();
            try
            {
                foreach (var Row in tempAllRowsList)
                {
                    DateTime dateTime;
                    var tempRow = Row;

                    if (tempRow.Contains("direction") || tempRow.Contains("dir") || tempRow.Contains("subscriber"))
                        continue;
                    if (tempRow.Contains(",,"))
                        tempRow = tempRow.Replace(",,", ",null,");
                    var tempSplitRow = Regex.Matches(tempRow, @"(?<="")[^""]+?(?=""(?:\s*?,|\s*?$))|(?<=(?:^|,)\s*?)(?:[^,""\s][^,""]*[^,""\s])|(?:[^,""\s])(?![^""]*?""(?:\s*?,|\s*?$))(?=\s*?(?:,|$))").Cast<Match>().Select(m => m.Value).ToArray();
                    if (tempSplitRow.Length == 0 || tempSplitRow.Length < 6)
                        continue;

                    CallData callData = new CallData();
                    MonthlyCostData monthlyCostData = new MonthlyCostData();
                    if (!string.IsNullOrEmpty(tempSplitRow[0]))
                        callData.Bedrijf = tempSplitRow[0];
                    if (!string.IsNullOrEmpty(tempSplitRow[1]))
                    {
                        callData.Subscriber = tempSplitRow[1];
                        monthlyCostData.Subscriber= tempSplitRow[1];
                    }
                        if (!string.IsNullOrEmpty(tempSplitRow[2]))
                        callData.Originator = tempSplitRow[2];
                    if (!string.IsNullOrEmpty(tempSplitRow[3]))
                        callData.Termination = tempSplitRow[3];
                    if (!string.IsNullOrEmpty(tempSplitRow[4]))
                        if (DateTime.TryParse(tempSplitRow[4], CultureInfo.InvariantCulture, DateTimeStyles.None, out dateTime))
                            callData.Date = dateTime;
                    if (!string.IsNullOrEmpty(tempSplitRow[5]))
                    {
                        if (!tempSplitRow[5].Contains("-"))
                            callData.Duration = double.Parse(tempSplitRow[5], CultureInfo.InvariantCulture);
                        else callData.Duration = 0;
                    }
                    if (!string.IsNullOrEmpty(tempSplitRow[6]))
                    {
                        if (!tempSplitRow[6].Contains("-"))
                            callData.Cost = double.Parse(tempSplitRow[6], CultureInfo.InvariantCulture);
                        else callData.Cost = 0;
                        tempParsedRowsList.Add(callData);
                    }
                }
            }
            catch (Exception ex)
            {
                Log.Error(ex.Message);
            }

            return tempParsedRowsList;
        }
    }
}